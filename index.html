<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Shooter</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
    height: 100%;
    width: 100%;
    font-family: sans-serif;
}
#game { display: block; background: #000; }
#damageFlash {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background:red; opacity:0; pointer-events:none; transition: opacity 0.08s linear;
}
#gameOver {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.9); color:red; display:none;
    align-items:center; justify-content:center; font-size:72px;
    font-family: 'Impact', sans-serif; text-shadow: 3px 3px 0 black, -3px -3px 0 black;
    flex-direction: column; z-index: 10;
}
#gameOver button {
    margin-top: 40px; padding: 20px 40px; font-size:36px; font-weight:bold;
    cursor:pointer; color:red; background:black; border: 3px solid red;
    text-shadow: 2px 2px 0 black;
}
#hpContainer {
    position: fixed; top: 10px; left: 10px; width: 200px; height: 20px; border: 2px solid cyan;
}
#hp {
    height:100%; width:100%; background:lime; text-align:center; color:black; font-weight:bold;
}
#scoreContainer {
    position: fixed; top: 10px; right: 10px; text-align: right; font-family: 'Impact', sans-serif;
    text-shadow: 2px 2px 0 black; color: yellow;
}
#score { font-size:32px; }
#bestScore { font-size:20px; color: orange; }
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="damageFlash"></div>
<div id="gameOver">
    GAME OVER
    <button onclick="restart()">RESTART</button>
</div>
<div id="hpContainer">
    <div id="hp">100</div>
</div>
<div id="scoreContainer">
    <div id="bestScore">Best: 0</div>
    <div id="score">0</div>
</div>

<!-- AUDIO -->
<audio id="shootSound" src="shoot.mp3"></audio>
<audio id="damageSound" src="damage.mp3"></audio>
<audio id="enemyDeathSound" src="enemyDeath.mp3"></audio>
<audio id="pickupSound" src="pickup.mp3"></audio>
<audio id="deathSound" src="death.mp3"></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const flash = document.getElementById("damageFlash");
const gameOverDiv = document.getElementById("gameOver");
const scoreEl = document.getElementById("score");
const bestScoreEl = document.getElementById("bestScore");

const MARGIN = 30;
const BORDER = 4;

let W,H,scale;
function resize(){
    W=window.innerWidth; H=window.innerHeight;
    canvas.width=W; canvas.height=H;
    scale=Math.min((W-MARGIN*2)/900,(H-MARGIN*2)/600);
}
window.addEventListener("resize",resize);
resize();

const arena={w:900,h:600};

let last=performance.now();
let keys={},bullets=[],enemies=[],drops=[];
let mouse={x:450,y:300};
let fireMode="single", fireTimer=0;
let gameRunning=true;
let score=0;
let bestScore = parseInt(localStorage.getItem("bestScore")) || 0;
bestScoreEl.textContent = "Best: " + bestScore;

const player={x:450,y:300,size:15,speed:250,life:100};

document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

canvas.addEventListener("click",()=>{ if(gameRunning) canvas.requestPointerLock(); });
document.addEventListener("pointerlockchange",()=>{ if(document.pointerLockElement!==canvas){ if(gameRunning) endGame(); } });
document.addEventListener("mousemove",e=>{ if(document.pointerLockElement===canvas){ mouse.x+=e.movementX/scale; mouse.y+=e.movementY/scale; } });
canvas.addEventListener("mousedown",()=>{ if(gameRunning) shoot(); });

function restart(){
    document.exitPointerLock();
    player.life=100; player.x=450; player.y=300;
    enemies=[]; bullets=[]; drops=[];
    fireMode="single"; fireTimer=0;
    gameRunning=true; gameOverDiv.style.display="none";
    score=0; scoreEl.textContent = score;
    enemyInterval = setInterval(spawnEnemy,1200);
}

function shoot(){ if(fireMode==="single") fire(); else for(let a=-0.2;a<=0.2;a+=0.2) fire(a); }
function fire(off=0){
    let dx=mouse.x-player.x;
    let dy=mouse.y-player.y;
    let ang=Math.atan2(dy,dx)+off;
    bullets.push({ x:player.x, y:player.y, vx:Math.cos(ang)*900, vy:Math.sin(ang)*900 });
    document.getElementById("shootSound").currentTime = 0;
    document.getElementById("shootSound").play();
}

const types=[ {c:"lime",d:5,s:90}, {c:"yellow",d:10,s:110}, {c:"deepskyblue",d:15,s:130}, {c:"red",d:20,s:150} ];

function spawnEnemy(){ 
    if(!gameRunning) return;
    let t=types[Math.floor(Math.random()*4)];
    let side=Math.floor(Math.random()*4);
    let x,y;
    if(side==0){x=0;y=Math.random()*arena.h;}
    if(side==1){x=arena.w;y=Math.random()*arena.h;}
    if(side==2){x=Math.random()*arena.w;y=0;}
    if(side==3){x=Math.random()*arena.w;y=arena.h;}
    enemies.push({x,y,size:16,color:t.c,damage:t.d,speed:t.s,justSpawned:true});
}
let enemyInterval = setInterval(spawnEnemy,1200);

function spawnDrop(){ let t=Math.random()<0.5?"gun":"hp"; drops.push({x:Math.random()*arena.w,y:-20,type:t}); }
setInterval(spawnDrop,5000);

function takeDamage(d){ 
    player.life-=d; 
    flash.style.opacity=.4; 
    document.getElementById("damageSound").currentTime=0;
    document.getElementById("damageSound").play();
    setTimeout(()=>flash.style.opacity=0,80); 
    if(player.life<=0) endGame(); 
}

function endGame(){ 
    gameRunning=false;
    document.getElementById("deathSound").currentTime = 0;
    document.getElementById("deathSound").play();
    gameOverDiv.style.display="flex"; 
    document.exitPointerLock(); 
    clearInterval(enemyInterval); 
    if(score > bestScore){
        bestScore = score;
        localStorage.setItem("bestScore", bestScore);
        bestScoreEl.textContent = "Best: " + bestScore;
    }
}

function update(dt){
    if(!gameRunning) return;
    let s=player.speed*dt;
    if(keys.w)player.y-=s;
    if(keys.s)player.y+=s;
    if(keys.a)player.x-=s;
    if(keys.d)player.x+=s;
    const pad=player.size;
    player.x=Math.max(pad,Math.min(arena.w-pad,player.x));
    player.y=Math.max(pad,Math.min(arena.h-pad,player.y));

    bullets.forEach((b,i)=>{ b.x+=b.vx*dt; b.y+=b.vy*dt; if(b.x<0||b.x>arena.w||b.y<0||b.y>arena.h) bullets.splice(i,1); });

    drops.forEach(d=>d.y+=180*dt);
    for(let i=drops.length-1;i>=0;i--){ 
        let d=drops[i]; 
        if(Math.hypot(d.x-player.x,d.y-player.y)<25){ 
            if(d.type==="gun"){fireMode="multi";fireTimer=3;} else player.life=Math.min(100,player.life+30); 
            drops.splice(i,1); 
        } 
    }

    if(fireTimer>0){fireTimer-=dt;if(fireTimer<=0)fireMode="single";}

    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i];
        let dx=player.x-e.x,dy=player.y-e.y;
        let d=Math.hypot(dx,dy);
        e.x+=dx/d*e.speed*dt;
        e.y+=dy/d*e.speed*dt;
        if(d<player.size+e.size){ takeDamage(e.damage); enemies.splice(i,1); continue; }
        for(let j=bullets.length-1;j>=0;j--){ 
            let b=bullets[j]; 
            if(Math.hypot(b.x-e.x,b.y-e.y)<e.size){ 
                enemies.splice(i,1); bullets.splice(j,1); score++; 
                scoreEl.textContent = score;
                document.getElementById("enemyDeathSound").currentTime = 0;
                document.getElementById("enemyDeathSound").play();
                break; 
            } 
        }
        e.justSpawned=false;
    }

    const hpEl=document.getElementById("hp");
    hpEl.style.width=player.life+"%";
    hpEl.textContent=Math.max(0,Math.floor(player.life));
}

function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,W,H);

    const ox=MARGIN+(W-(arena.w*scale+MARGIN*2))/2;
    const oy=MARGIN+(H-(arena.h*scale+MARGIN*2))/2;
    ctx.setTransform(scale,0,0,scale,ox,oy);

    ctx.strokeStyle="cyan";
    ctx.lineWidth=BORDER;
    ctx.shadowBlur=15;
    ctx.shadowColor="cyan";
    ctx.strokeRect(BORDER/2,BORDER/2,arena.w-BORDER,arena.h-BORDER);

    const tx=Math.max(0,Math.min(arena.w,mouse.x));
    const ty=Math.max(0,Math.min(arena.h,mouse.y));
    ctx.setLineDash([6,6]);
    ctx.strokeStyle="rgba(0,255,255,0.5)";
    ctx.beginPath();
    ctx.moveTo(player.x,player.y);
    ctx.lineTo(tx,ty);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.shadowBlur=20;
    ctx.shadowColor="cyan";
    ctx.fillStyle="cyan";
    ctx.beginPath();
    ctx.arc(player.x,player.y,player.size,0,Math.PI*2);
    ctx.fill();

    bullets.forEach(b=>{
        ctx.strokeStyle="cyan";
        ctx.lineWidth=3;
        ctx.shadowBlur=15;
        ctx.beginPath();
        ctx.moveTo(b.x - b.vx*0.02, b.y - b.vy*0.02);
        ctx.lineTo(b.x,b.y);
        ctx.stroke();
    });

    enemies.forEach(e=>{
        if(e.justSpawned){ctx.shadowBlur=0;} else{ctx.shadowColor=e.color;ctx.shadowBlur=15;}
        ctx.fillStyle=e.color;
        ctx.beginPath();
        ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
        ctx.fill();
    });

    drops.forEach(d=>{
        if(d.type==="gun"){
            ctx.fillStyle=`hsl(${Date.now()%360},100%,50%)`;
            ctx.beginPath();
            ctx.moveTo(d.x,d.y-12);
            ctx.lineTo(d.x+12,d.y);
            ctx.lineTo(d.x,d.y+12);
            ctx.lineTo(d.x-12,d.y);
            ctx.closePath();
            ctx.fill();
        }else{
            ctx.fillStyle="red";
            ctx.fillRect(d.x-5,d.y-15,10,30);
            ctx.fillRect(d.x-15,d.y-5,30,10);
        }
    });
}

function loop(t){
    let dt=(t-last)/1000;
    last=t;
    update(dt);
    draw();
    requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
